# Opensearch Workflow

## Overview
Workflow performs testing of the [Qubership-opensearch service](https://github.com/Netcracker/qubership-opensearch) across various scenarios.

## Input Parameters
<!-- markdownlint-disable line-length -->
| Parameter       | Type   | Required | Description                                                      | Default                                                   |
|-----------------|--------|----------|------------------------------------------------------------------|-----------------------------------------------------------|
| service_branch  | string | No       | Branch of qubership-opensearch repository                         | -                                                         |
| versions_file   | string | Yes      | Path to file with version list in qubership-opensearch repository | -                                                         |
| pipeline_branch | string | Yes      | Branch of qubership-test-pipelines repository                    | -                                                         |
| runner_type     | string | No       | Runner type (self-hosted or ubuntu-latest)                       | self-hosted <br/>(Opensearch requires a lot of resources) |
<!-- markdownlint-enable line-length -->

## Secrets list
<!-- markdownlint-disable line-length -->
| Secret                     | Required | Description             |
|----------------------------|----------|-------------------------|
| AWS_S3_ACCESS_KEY_ID       | Yes      | AWS Access Key for S3   |
| AWS_S3_ACCESS_KEY_SECRET   | Yes      | AWS Secret Key for S3   |
<!-- markdownlint-enable line-length -->

## Jobs list

### Versions
- **[LATEST]**: Current Opensearch branch (`${{inputs.service_branch}}`) that triggered the pipeline
- **[PREVIOUS]**: Version(s) from the `versions` output generated by `prepare-versions` step

## 0. prepare-versions
**Name**: Prepare versions for testing  
**Description**: Prepares version list for testing.  
**Outputs**:
- `versions`: JSON array of versions (e.g., `["1.0.0", "1.0.1"]`)
- `previous_version`: Last version in the list (e.g., `"1.0.1"`)  
  **Key Steps**:
- Process versions file   
  Reads `version.yaml` file from Opensearch repository and converts to JSON

## 1. Clean-Latest-Upgrade-Diff-Params
**Name**: Clean [LATEST], Upgrade [LATEST] Diff Params  
**Description**:  
Clean Deploy with [LATEST] version. Rolling Update with same version, but with changed deployment config    
**Key Steps**:
- Clean Install Opensearch [LATEST]  
  (Uses template: `opensearch_clean_all_on_sc.yml`)
- Update to [LATEST] Version With Diff Params  
  (Uses template: `opensearch_clean_all_on_sc_updated.yml`)
- Verify Opensearch upgrade

## 2. Clean-Latest-Restricted
**Name**: Clean [LATEST] Restricted  
**Description**:  
Clean Deploy [LATEST] version in restricted mode    
**Key Steps**:
- Install Python with dependencies
- Clean Install Opensearch [LATEST] in Restricted mode  
  (Uses template: `opensearch_clean_all_on_sc_restricted.yml` with `restricted: true`)

## 3. Clean-Latest-S3-TLS
**Name**: Clean [LATEST] TLS  
**Description**:  
Clean Deploy [LATEST] version with TLS, Get Opensearch Certs, Get Backup-Daemon Certs.
**Key Steps**:
- Install Python with dependencies
- Install cert-manager
- Create ClusterIssuer
- Update YAML secrets  
  (Uses script `update_yaml.py` for S3 credentials)
- Install Opensearch [LATEST] S3 with TLS  
  (Uses template: `opensearch_clean_all_on_sc_tls_s3.yml`)

## 4. Clean-Previous-Update-To-Latest
**Name**: Clean [PREVIOUS], Update to [LATEST]  
**Dependencies**: `prepare-versions` (version matrix)  
**Description**:  
Clean Deploy with [PREVIOUS] releases from file. Rolling Update from [PREVIOUS] release to [LATEST]
**Key Steps**:
- Clean Install Opensearch [PREVIOUS]
  (Uses template: `opensearch_clean_all_on_sc.yml`)
- Update Opensearch to [LATEST]  
  (Same template with `deploy_mode: upgrade`)
