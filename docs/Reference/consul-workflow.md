# Consul Workflow

## Overview
Workflow performs testing of the [Qubership-consul service](https://github.com/Netcracker/qubership-consul/tree/main) across various scenarios.

## Input Parameters
<!-- markdownlint-disable line-length -->
| Parameter       | Type   | Required | Description                                                   | Default        |
|-----------------|--------|----------|---------------------------------------------------------------|----------------|
| service_branch  | string | No       | Branch of qubership-consul repository                         | -              |
| versions_file   | string | Yes      | Path to file with version list in qubership-consul repository | -              |
| pipeline_branch | string | Yes      | Branch of qubership-test-pipelines repository                 | -              |
| runner_type     | string | No       | Runner type (self-hosted or ubuntu-latest)                    | ubuntu-latest  |
<!-- markdownlint-enable line-length -->

## Secrets list
<!-- markdownlint-disable line-length -->
| Secret                     | Required | Description             |
|----------------------------|----------|-------------------------|
| AWS_S3_ACCESS_KEY_ID       | Yes      | AWS Access Key for S3   |
| AWS_S3_ACCESS_KEY_SECRET   | Yes      | AWS Secret Key for S3   |
<!-- markdownlint-enable line-length -->

## Jobs list

## Versions: 
- **[LATEST]**: Current Consul branch (`${{inputs.service_branch}}`) that triggered the pipeline
- **[PREVIOUS]**: Version(s) from the `versions` output generated by `prepare-versions` step

## 0. prepare-versions
**Description**: Prepares version list for testing.  
**Outputs**:  
- `versions`: JSON array of versions (e.g., `["v1.0", "v2.0"]`)  
- `previous_version`: Last version in the list (e.g., `"v2.0"`)  
**Key Steps**:  
- Process versions file: Reads version file and converts to JSON  

## 1. Clean-Latest-Upgrade-Diff-Params
**Name**: Clean [LATEST], Upgrade [LATEST] Diff Params  
**Description**  
Clean Deploy with [LATEST] version. Rolling Update with same version, but with changed deployment config. 
**Key Steps**:  
- Clean Install Consul [LATEST]  
  (Uses template: `consul_clean_all_on_sc.yml`)  
- Update to [LATEST] Version With Diff Params  
  (Uses template: `consul_clean_all_on_sc_updated.yml`)  

## 2. Clean-Latest-Restricted
**Name**: Clean [LATEST] Restricted  
**Description**  
Clean Deploy with [LATEST] version in restricted mode. 
**Key Steps**:  
- Clean Install Consul [LATEST] in Restricted mode  
  (Uses template: `consul_clean_all_on_sc_restricted.yml` with `restricted: true`)  

## 3. Clean-Latest-Full-At-ports-Specifying-Custom-Labels
**Name**: Clean [LATEST] Full-AT Ports-specifying Custom-labels  
**Description**  
Clean Deploy [LATEST] version with Ports specifying for global, servers and clients and with full scope auto-tests  
**Key Steps**:  
- Clean Install Consul [LATEST] Full-At  
  (Uses template: `consul_clean_all_on_sc_full_at.yml`)  

## 4. Clean-WO-Components-Upgrade-All-Components-S3
**Name**: Clean [LATEST] W/O Components, Upgrade [LATEST] All Components S3  
**Description**  
Clean Deploy with [LATEST] version without additional components, upgrade to same version with all components and S3 storage.  
**Key Steps**:  
- Clean Install Consul [LATEST] W/O Components  
  (Uses template: `consul_clean_on_sc_without_components.yml`)  
- Add secrets to template
- Update Consul [LATEST] All Components S3  
  (Uses template: `consul_clean_all_on_sc_drd_s3.yml`)  

## 5. Clean-Previous-Update-To-Latest
**Name**: Clean [PREVIOUS], Update to [LATEST]  
**Description**  
Clean Deploy with [PREVIOUS] version from `versions`. Rolling Update from [PREVIOUS] to [LATEST].
**Dependencies**:  
`prepare-versions` (uses matrix: `${{fromJson(needs.prepare-versions.outputs.versions)}}`)  
**Key Steps**:  
- Clean Install Consul [PREVIOUS]  
  (Uses template: `consul_clean_all_on_sc.yml`)  
- Update Consul to [LATEST]  
  (Same template with `deploy_mode: upgrade`)  

## 6. Clean-Previous-Upgrade-To-Latest-Restricted
**Name**: Clean [PREVIOUS] Restricted, Upgrade To [LATEST] Restricted  
**Description**  
Clean Deploy  with [PREVIOUS] version in restricted mode. Rolling Update job to [LATEST] version in restricted mode.
**Dependencies**:  
`prepare-versions` (uses `previous_version` output)  
**Key Steps**:  
- Clean Install Consul [PREVIOUS] in Restricted mode  
- Update Consul to [LATEST] in Restricted mode  
  (Uses template: `consul_clean_all_on_sc_restricted.yml`, `restricted: true`)  

## 7. Clean-Latest-S3-TLS
**Name**: Clean [LATEST] S3 TLS  
**Description** 
Clean Deploy with [LATEST] version with S3 storage and TLS.
**Key Steps**:  
- Install cert-manager  
  (Helm install: `jetstack/cert-manager`)  
- Create ClusterIssuer  
  (Self-signed issuer configuration)  
- Add secrets to template
- Clean Install Consul [LATEST] S3 TLS  
  (Uses template: `consul_clean_all_on_sc_drd_s3_tls.yml`) 
