# RabbitMQ Workflow

## Overview
Workflow performs testing of the [Qubership-rabbitmq service](https://github.com/Netcracker/qubership-rabbitmq) across various scenarios.

## Input Parameters
<!-- markdownlint-disable line-length -->

| Parameter       | Type   | Required | Description                                                     | Default       |
|-----------------|--------|----------|-----------------------------------------------------------------|---------------|
| service_branch  | string | No       | Branch of qubership-rabbitmq repository                         | -             |
| pipeline_branch | string | Yes      | Branch of qubership-test-pipelines repository                   | -             |
| runner_type     | string | No       | Runner type (ubuntu-latest or self-hosted)                      | ubuntu-latest |
<!-- markdownlint-enable line-length -->

## Secrets list
<!-- markdownlint-disable line-length -->
| Secret                     | Required | Description             |
|----------------------------|----------|-------------------------|
| AWS_S3_ACCESS_KEY_ID       | Yes      | AWS Access Key for S3   |
| AWS_S3_ACCESS_KEY_SECRET   | Yes      | AWS Secret Key for S3   |
<!-- markdownlint-enable line-length -->

## Jobs list

### Versions
- **[LATEST]**: Current RabbitMQ branch (`${{inputs.service_branch}}`) that triggered the pipeline
- **[PREVIOUS]**: Version(s) from the `versions` output generated by `prepare-versions` step

## 0. prepare-versions
**Name**: Prepare versions for testing  
**Description**: Prepares version list for testing.  
**Outputs**:
- `versions`: JSON array of versions (e.g., `["1.0.0", "1.0.1"]`)  
- `previous_version`: Last version in the list (e.g., `"1.0.1"`)

**Key Steps**:
- Process versions file   
  Reads `version.yaml` file from RabbitMQ repository and converts to JSON

## 1. Clean-Latest-Update-Diff-Params
**Name**: Clean [LATEST], Update [LATEST] Diff Params  
**Description**: Clean Deploy with [LATEST] version. Rolling Update within the same version, but with changed deployment parameters  

**Key Steps**:
- Clean Install RabbitMQ [LATEST]  
  (Uses template: `rabbitmq_clean_sc.yml`)
- Verify RabbitMQ installation
- Update RabbitMQ to [LATEST] Version With Diff Params  
  (Uses template: `rabbitmq_update_sc.ymll`)
- Verify RabbitMQ update

## 2. Clean-Latest-Restricted
**Name**: Clean [LATEST] in Restricted mode
**Description**: Clean Deploy [LATEST] version in Restricted mode

**Key Steps**:
- Clean Install RabbitMQ [LATEST] with `restricted: true`  
  (Uses template: `rabbitmq_clean_sc_restricted.yml`)
- Verify RabbitMQ installation

## 3. Clean-Latest-S3
**Name**: Clean [LATEST] on S3 storage  
**Description**: Clean Deploy [LATEST] version with backupDaemon on S3 storage

**Key Steps**:
- Update YAML secrets
  (Uses script `update_yaml.py` for S3 credentials)
- Clean Install RabbitMQ [LATEST] on s3  
  (Uses template: `rabbitmq_clean_sc_s3.yml`)
- Verify RabbitMQ installation

## 4. Clean-Latest-S3-drd
**Name**: Clean [LATEST] on S3 storage in disasterRecovery mode  
**Description**: Clean Deploy [LATEST] version with backupDaemon on S3 storage in disasterRecovery mode

**Key Steps**:
- Update YAML secrets  
  (Uses script `update_yaml.py` for S3 credentials)
- Clean Install RabbitMQ [LATEST] on s3 in drd  
  (Uses template: `rabbitmq_clean_sc_s3_drd.yml`)
- Verify RabbitMQ installation

## 5. Clean-Latest-S3-drd-TLS
**Name**: Clean [LATEST] on S3 storage in disasterRecovery mode and TLS  
**Description**: Clean Deploy [LATEST] version with backupDaemon on S3 storage in disasterRecovery mode using cert-manager

**Key Steps**:
- Install cert-manager via helm
- Create test clusterissuer
- Update YAML secrets  
  (Uses script `update_yaml.py` for S3 credentials)
- Clean Install RabbitMQ [LATEST] on s3 in drd with TLS  
  (Uses template: `rabbitmq_clean_sc_s3_drd.yml`)
- Verify RabbitMQ installation

## 6. Clean-Previous-Upgrade-To-Latest
**Name**: Clean [N1_RELEASE], Upgrade From [N1_RELEASE] To [LATEST_SPRINT]; Clean [N2_RELEASE], Upgrade From [N2_RELEASE] To [LATEST_SPRINT]  
**Dependencies**: `prepare-versions` (version matrix)  
**Description**: Clean Deploy with [PREVIOUS] releases from file. Rolling Update from [PREVIOUS] release to [LATEST]

**Key Steps**:
- Clean Install RabbitMQ [PREVIOUS] version  
  (Uses template: `rabbitmq_clean_sc.yml`)
- Verify RabbitMQ installation
- Upgrade RabbitMQ to [LATEST] version  
  (Same template with `deploy_mode: upgrade`)
- Verify RabbitMQ installation
