# Kafka Workflow

## Overview
Workflow performs testing of the [Qubership-kafka service](https://github.com/Netcracker/qubership-kafka) across various scenarios.

## Input Parameters
<!-- markdownlint-disable line-length -->
| Parameter       | Type   | Required | Description                                              | Default |
|-----------------|--------|----------|----------------------------------------------------------|---------|
| service_branch  | string | No       | Branch of qubership-kafka repository                     | -       |
| versions_file   | string | Yes      | Path to file with version list in qubership-kafka repository | -       |
| pipeline_branch | string | Yes      | Branch of qubership-test-pipelines repository            | -       |
| runner_type     | string | No       | Runner type (ubuntu-latest or self-hosted)               | ubuntu-latest       |
<!-- markdownlint-enable line-length -->

## Secrets list
<!-- markdownlint-disable line-length -->
| Secret                     | Required | Description             |
|----------------------------|----------|-------------------------|
| AWS_S3_ACCESS_KEY_ID       | Yes      | AWS Access Key for S3   |
| AWS_S3_ACCESS_KEY_SECRET   | Yes      | AWS Secret Key for S3   |
<!-- markdownlint-enable line-length -->

## Jobs list

### Versions
- **[LATEST]**: Current Kafka branch (`${{inputs.service_branch}}`) that triggered the pipeline
- **[PREVIOUS]**: Version(s) from the `versions` output generated by `prepare-versions` step

## 0. prepare-versions
**Name**: Prepare versions for testing  
**Description**: Prepares version list for testing.  
**Outputs**:
- `versions`: JSON array of versions (e.g., `["1.0.0", "1.0.1"]`)  
- `previous_version`: Last version in the list (e.g., `"1.0.1"`)

**Key Steps**:
- Process versions file   
  Reads `version.yaml` file from Kafka repository and converts to JSON

## 1. Clean-Latest-Update-Diff-Params-Kraft
**Name**: Clean [LATEST], Update [LATEST] Diff Params in Kraft mode  
**Description**: Clean Deploy with [LATEST] version without Zookeeper in Kraft mode. Rolling Update within the same version, but with changed deployment parameters  
**Key Steps**:
- Clean Install Kafka [LATEST]  
  (Uses template: `kafka_clean_kraft_mode.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [LATEST]
  (Uses template: `kafka_clean_kraft_mode.yml`)
- Verify Kafka Service installation
- Update Kafka to [LATEST] Version With Diff Params
  (Uses template: `kafka_update_kraft_mode.yml`)
- Verify Kafka update
- Update Kafka Service to [LATEST] Version With Diff Params
  (Uses template: `kafka_update_kraft_mode.yml`)
- Verify Kafka Service update

## 2. Clean-Latest-Zookeeper-non-TLS
**Name**: Clean [LATEST] with Zookeeper in non-TLS  
**Description**: Clean Deploy [LATEST] version with Zookeeper with disabled TLS

**Key Steps**:
- Clean Install Zookeeper [LATEST]
  (Uses template: `zookeeper_install_APP_k8s.yml`)
- Verify Zookeeper installation
- Clean Install Kafka [LATEST]
  (Uses template: `kafka_clean_sc_zoo.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [LATEST]
  (Uses template: `kafka_clean_sc_zoo.yml`
- Verify Kafka Service installation

## 3. Clean-Latest-Zookeeper-TLS
**Name**: Clean [LATEST] with Zookeeper in TLS  
**Description**: Clean Deploy [LATEST] version with TLS using cert-manager and `zookeeperEnableSsl: false`

**Key Steps**:
- Install cert-manager
- Create Issuer, CA Certificate and Cluster Issuer to issue certificates
- Clean Install Zookeeper [LATEST] without TLS
  (Uses template: `zookeeper_install_APP_k8s.yml`)
- Verify Zookeeper installation
- Clean Install Kafka [LATEST] in TLS
  (Uses template: `kafka_clean_sc_zoo_tls_false.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [LATEST] in TLS
  (Uses template: `kafka_clean_sc_zoo_tls_false.yml`)
- Verify Kafka Service installation

## 4. Clean-Latest-Zookeeper-both-TLS
**Name**: Clean [LATEST] with Zookeeper when both are in TLS  
**Description**: Clean Deploy [LATEST] version with TLS using cert-manager and `zookeeperEnableSsl: true`

**Key Steps**:
- Install cert-manager
- Create Issuer, CA Certificate and Cluster Issuer to issue certificates
- Clean Install Zookeeper [LATEST] in TLS
  (Uses template: `zookeeper_install_tls_APP_k8s.yml`)
- Verify Zookeeper installation
- Clean Install Kafka [LATEST] in TLS
  (Uses template: `kafka_clean_sc_zoo_tls.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [LATEST] in TLS
  (Uses template: `kafka_clean_sc_zoo_tls.yml`)
- Verify Kafka Service installation

## 5. Clean-Latest-Zookeeper-S3
**Name**: Clean [LATEST] with Zookeeper on S3  
**Description**: Clean Deploy [LATEST] version on S3 storage

**Key Steps**:
- Clean Install Zookeeper [LATEST]
  (Uses template: `zookeeper_install_APP_k8s.yml`)
- Verify Zookeeper installation
- Update YAML secrets
  (Uses script `update_yaml.py` for S3 credentials)
- Clean Install Kafka [LATEST] on s3
  (Uses template: `kafka_clean_sc_zoo_s3.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [LATEST] on s3
  (Uses template: `kafka_clean_sc_zoo_s3.yml`)
- Verify Kafka Service installation


## 6. Clean-Previous-Upgrade-To-Latest
**Name**: Clean [N1_RELEASE], Upgrade From [N1_RELEASE] To [LATEST_SPRINT]; Clean [N2_RELEASE], Upgrade From [N2_RELEASE] To [LATEST_SPRINT]  
**Dependencies**: `prepare-versions` (version matrix)  
**Description**: Clean Deploy with [PREVIOUS] releases from file. Rolling Update from [PREVIOUS] release to [LATEST]

**Key Steps**:
- Clean Install Zookeeper [LATEST]
  (Uses template: `zookeeper_install_APP_k8s.yml`)
- Verify Zookeeper installation
- Clean Install Kafka [PREVIOUS]
  (Uses template: `kafka_clean_sc_zoo.yml`)
- Verify Kafka installation
- Clean Install Kafka Service [PREVIOUS]
  (Uses template: `kafka_clean_sc_zoo.yml`)
- Verify Kafka Service installation
- Upgrade Kafka to [LATEST]
  (Same template with `deploy_mode: upgrade`)
- Verify Kafka installation
- Upgrade Kafka Service to [LATEST]
  (Same template with `deploy_mode: upgrade`)
- Verify Kafka Service installation
