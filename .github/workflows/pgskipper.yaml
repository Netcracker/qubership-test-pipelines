name: Pgskipper Tests

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository with Pgskipper service'
        required: false
        type: string
        default: 'Netcracker/pgskipper-operator'
      service_branch:
        description: 'Branch of pgskipper-operator repository'
        required: false
        type: string
        default: 'main'
      versions_file:
        description: 'Path to file with version list'
        type: string
        required: true
        default: '.github/versions.yaml'
      pipeline_branch:
        description: 'Branch of qubership-test-pipelines repository'
        type: string
        required: true
        default: 'main'
      runner_type:
        description: 'Runner type (self-hosted or ubuntu-latest)'
        type: string
        required: false
        default: 'ubuntu-latest'
      pg_16_image:
        description: 'Image for Postgres 16'
        type: string
        required: false
        default: 'pgskipper-patroni-16'
      pg_17_image:
        description: 'Image for Postgres 17'
        type: string
        required: false
        default: 'pgskipper-patroni-17'
      pg_18_image:
        description: 'Image for Postgres 18 (second migration, should be empty if you have only 2 pg versions)'
        type: string
        required: false
        default: ''
      image_replacement:
        description: 'Value for change version in chart'
        type: string
        required: false
        default: ''
  workflow_call:
    inputs:
      repository_name:
        description: 'Repository with Pgskipper service'
        required: false
        type: string
        default: 'Netcracker/pgskipper-operator'
      service_branch:
        description: 'Branch of pgskipper-operator repository'
        required: false
        type: string
        default: 'main'
      versions_file:
        description: 'Path to file with version list'
        type: string
        required: true
        default: '.github/versions.yaml'
      pipeline_branch:
        description: 'Branch of qubership-test-pipelines repository'
        type: string
        required: true
        default: 'main'
      runner_type:
        description: 'Runner type (self-hosted or ubuntu-latest)'
        type: string
        required: false
        default: 'ubuntu-latest'
      pg_16_image:
        description: 'Image for Postgres 16'
        type: string
        required: false
        default: 'pgskipper-patroni-16'
      pg_17_image:
        description: 'Image for Postgres 17'
        type: string
        required: false
        default: 'pgskipper-patroni-17'
      pg_18_image:
        description: 'Image for Postgres 18 (second migration, should be empty if you have only 2 pg versions)'
        type: string
        required: false
        default: ''
      image_replacement:
        description: 'Value for change version in chart'
        type: string
        required: false
        default: ''
    secrets:
      AWS_S3_ACCESS_KEY_ID:
        required: true
      AWS_S3_ACCESS_KEY_SECRET:
        required: true

jobs:
  prepare:
    runs-on: ${{ inputs.runner_type }}
    outputs:
      versions: ${{ steps.process-versions.outputs.versions }}
      previous_version: ${{ steps.process-versions.outputs.previous_version }}
      matrix: ${{ steps.process-versions.outputs.matrix }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: '${{ inputs.service_branch }}'
          repository: '${{ inputs.repository_name }}'
          path: 'pgskipper-operator'

      - name: Checkout pipeline
        uses: actions/checkout@v5
        with:
          ref: '${{ inputs.pipeline_branch }}'
          repository: '${{ github.repository_owner }}/qubership-test-pipelines'
          path: 'qubership-test-pipelines'

      - name: Process versions file and matrix generation
        id: process-versions
        working-directory: "${{ github.workspace }}/qubership-test-pipelines"
        run: |
          chmod +x ./scripts/matrix.sh
          ./scripts/matrix.sh ${{ github.workspace }}/pgskipper-operator/${{ inputs.versions_file }} ./workflow-config/pgskipper.yaml "${{ inputs.service_branch }}"

  Pgskipper-Test-Cases:
    needs: prepare
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.prepare.outputs.matrix) }}
        service_version_image: [ "${{ inputs.pg_16_image }}", "${{ inputs.pg_17_image }}" ]
    name: "${{ matrix.service_version_image }} | ${{ matrix.test.name }}"
    steps:
      # == 01 Start ======= Common pre-steps for all tests =======
      - name: "Print job parameters"
        run: |
          echo "======== Job parameters ======="
          echo "${{ toJson(matrix.test) }}"

      - name: Checkout pipeline
        uses: actions/checkout@v5
        with:
          ref: '${{ inputs.pipeline_branch }}'
          repository: 'netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'

      - name: Free Disk Space (Ubuntu)
        if: inputs.runner_type == 'ubuntu-latest'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      # == 01 End ======= Common pre-steps for all tests =======

      # == Start TLS certs addition if needed =======
      - name: TLS setup
        # language=bash
        if: matrix.test.tls == true
        run: |
          echo "::group::Install cert-manager"
          helm repo add jetstack https://charts.jetstack.io --force-update
          helm upgrade --install cert-manager jetstack/cert-manager --namespace cert-manager \
            --create-namespace --version v1.16.3 --set prometheus.enabled=true   --set crds.enabled=true
          echo "::endgroup::"
          echo "::group::Create cert-manager entities"
          kubectl apply -f qubership-test-pipelines/resources/test-issuer.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-certificate.yaml
          sleep 10s
          kubectl apply -f qubership-test-pipelines/resources/test-clusterissuer.yaml
          echo "::endgroup::"
          echo "::group::Get cert-manager resources"
          kubectl get pods -n cert-manager
          kubectl get secrets -n cert-manager
          kubectl get certificates -A
          echo "::endgroup::"
          echo "::group:: Get clusterissuer"
          kubectl get clusterissuer
          kubectl get clusterissuer test-clusterissuer -o yaml
          echo "::endgroup::"
      # == End TLS certs addition if needed =======

      # == 02 Start ======= Core installation steps =======
      - name: Install Pgskipper Core [${{ matrix.test.install_version }}]
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: '${{ matrix.test.core_template }}'
          service_branch: '${{ matrix.test.install_version }}'
          deploy_mode: 'install'
          restricted: ${{ matrix.test.restricted }}
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ matrix.service_version_image }}

      - name: Verify Pgskipper Core installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: '${{ matrix.test.install_version }}'
          check_tests: '${{ matrix.test.check_core_tests }}'
          artifact_name: 'Core_Installation_${{ matrix.test.artifact_name }}'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 02 End ======= Core installation steps =======

      # == 03 Start ======= Services installation steps =======
      - name: Install Pgskipper Services [${{ matrix.test.install_version }}]
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: '${{ matrix.test.services_template }}'
          service_branch: '${{ matrix.test.install_version }}'
          service_name: 'pgskipper-services'
          restricted: ${{ matrix.test.restricted }}
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-services'
          namespace: 'pgskipper'

      - name: Verify Pgskipper Services installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: '${{ matrix.test.install_version }}'
          check_tests: '${{ matrix.test.check_services_tests }}'
          artifact_name: 'Services_Installation_${{ matrix.test.artifact_name }}'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 03 End ======= Services installation steps =======

      # == Start ======= Specific steps for upgrade tests =======
      - name: Upgrade Pgskipper Core to [${{ matrix.test.upgrade_version }}]
        if: matrix.test.sequence == 'upgrade'
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          deploy_mode: 'upgrade'
          path_to_template: '${{ matrix.test.upgrade_core_template }}'
          service_branch: '${{ matrix.test.upgrade_version }}'
          restricted: ${{ matrix.test.restricted }}
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ matrix.service_version_image }}

      - name: Sleep after core upgrade 
        if: matrix.test.sequence == 'upgrade'
        run: sleep 30s

      - name: Verify Pgskipper Core upgrade
        if: matrix.test.sequence == 'upgrade'
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: ${{ matrix.test.upgrade_version }}
          check_tests: ${{ matrix.test.check_core_tests }}
          artifact_name: 'Core_Upgrade_${{ matrix.test.artifact_name }}'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'

      - name: Upgrade Pgskipper Services to [${{ matrix.test.upgrade_version }}]
        if: matrix.test.sequence == 'upgrade'
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          deploy_mode: upgrade
          path_to_template: '${{ matrix.test.upgrade_services_template }}'
          service_branch: '${{ matrix.test.upgrade_version }}'
          service_name: 'pgskipper-services'
          restricted: ${{ matrix.test.restricted }}
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-services'
          namespace: 'pgskipper'

      - name: Sleep after services upgrade
        if: matrix.test.sequence == 'upgrade'
        run: sleep 30s

      - name: Verify Pgskipper Services upgrade
        if: matrix.test.sequence == 'upgrade'
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: '${{ matrix.test.upgrade_version }}'
          check_tests: '${{ matrix.test.check_services_tests }}'
          artifact_name: 'Services_Upgrade_$_${{ matrix.test.artifact_name }}'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == End ======= Specific steps for upgrade tests =======

      # == Start ======= Diagnostic steps =======
      - name: Collect diagnostic information
        if: always()
        run: |
          echo "::group::Describe nodes"
          kubectl describe nodes
          echo "::endgroup::"
          echo "::group::Get events"
          kubectl get events --sort-by=.metadata.creationTimestamp -n pgskipper
          echo "::endgroup::"
          echo "::group::Get pods"
          kubectl get pods -n pgskipper -o wide
          echo "::endgroup::"
      # == End ======= Diagnostic steps =======


# =============================================================================
# MIGRATION CASES
# =============================================================================

  Migration-16-to-17:
    runs-on: ${{ inputs.runner_type }}
    name: "Migration ${{ inputs.pg_16_image }} to ${{ inputs.pg_17_image }}"
    steps:
      # == 01 Start ======= Common pre-steps for all tests =======
      - name: Checkout pipeline
        uses: actions/checkout@v5
        with:
          ref: '${{ inputs.pipeline_branch }}'
          repository: 'netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'

      - name: Free Disk Space (Ubuntu)
        if: inputs.runner_type == 'ubuntu-latest'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      # == 01 End ======= Common pre-steps for all tests =======

      # == 02 Start ======= Core installation steps =======
      - name: Install Pgskipper Core ${{ inputs.pg_16_image }}
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: 'templates/pgskipper/patroni-core-quickstart-sample.yaml'
          service_branch: "${{ inputs.service_branch }}"
          deploy_mode: 'install'
          restricted: false
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ inputs.pg_16_image }}

      - name: Verify Pgskipper Core installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Core_Installation_Migr_16'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 02 End ======= Core installation steps =======

      # == 03 Start ======= Services installation steps =======
      - name: Install Pgskipper Services
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: 'templates/pgskipper/patroni-services-quickstart-sample.yaml'
          service_branch: "${{ inputs.service_branch }}"
          service_name: 'pgskipper-services'
          restricted: false
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-services'
          namespace: 'pgskipper'

      - name: Verify Pgskipper Services installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Services_Installation_Migr_16'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 03 End ======= Services installation steps =======

      # == 04 Start ======= Migration steps =======
      - name: Major Upgrade Pgskipper Core to ${{ inputs.pg_17_image }}
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          deploy_mode: 'upgrade'
          path_to_template: 'templates/pgskipper/patroni-core-majorupgrade.yaml'
          service_branch: "${{ inputs.service_branch }}"
          restricted: false
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ inputs.pg_17_image }}

      - name: Sleep after core upgrade 
        run: sleep 30s

      - name: Verify Pgskipper Core upgrade
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Core_Upgrade_Migr_to_17'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 04 End ======= Migration steps =======
      # == 05 Start ======= Collect Artifacts =======
      - name: Dump Upgrade Logs
        if: always()
        run: |
          mkdir -p upgrade_logs_dump
          POD=$(kubectl get pods -n pgskipper --no-headers -o custom-columns=":metadata.name" | grep "major" | head -n 1 | tr -d '\r')
          if [ -z "$POD" ]; then
            echo "::warning:: ‚ö†Ô∏è Could not find any pod with 'major' in name. Skipping log dump."
            exit 0
          fi
          echo "üì• Dumping logs from upgrade pod: $POD..."
          kubectl cp pgskipper/$POD:/var/lib/pgsql/data/tmp/pg/pg_upgrade_output.d ./upgrade_logs_dump/ || echo "‚ö†Ô∏è No upgrade logs found inside pod (or path is incorrect)"

      - name: Upload Upgrade Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upgrade-logs-major1617
          path: upgrade_logs_dump/
          retention-days: 5
      # == 05 End ======= Collect Artifacts =======
      # == Start ======= Diagnostic steps =======
      - name: Collect diagnostic information
        if: always()
        run: |
          echo "::group::Describe nodes"
          kubectl describe nodes
          echo "::endgroup::"
          echo "::group::Get events"
          kubectl get events --sort-by=.metadata.creationTimestamp -n pgskipper
          echo "::endgroup::"
          echo "::group::Get pods"
          kubectl get pods -n pgskipper -o wide
          echo "::endgroup::"
      # == End ======= Diagnostic steps =======


  Migration-17-to-18:
    runs-on: ${{ inputs.runner_type }}
    name: "Migration ${{ inputs.pg_17_image }} to ${{ inputs.pg_18_image }}"
    if: inputs.pg_18_image != ''
    steps:
      # == 01 Start ======= Common pre-steps for all tests =======
      - name: Checkout pipeline
        uses: actions/checkout@v5
        with:
          ref: '${{ inputs.pipeline_branch }}'
          repository: 'netcracker/qubership-test-pipelines'
          path: 'qubership-test-pipelines'

      - name: Free Disk Space (Ubuntu)
        if: inputs.runner_type == 'ubuntu-latest'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Create cluster
        uses: ./qubership-test-pipelines/actions/shared/create_cluster
      # == 01 End ======= Common pre-steps for all tests =======

      # == 02 Start ======= Core installation steps =======
      - name: Install Pgskipper Core ${{ inputs.pg_17_image }}
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: 'templates/pgskipper/patroni-core-quickstart-sample.yaml'
          service_branch: "${{ inputs.service_branch }}"
          deploy_mode: 'install'
          restricted: false
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ inputs.pg_17_image }}

      - name: Verify Pgskipper Core installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Core_Installation_Migr_17'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 02 End ======= Core installation steps =======

      # == 03 Start ======= Services installation steps =======
      - name: Install Pgskipper Services
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          path_to_template: 'templates/pgskipper/patroni-services-quickstart-sample.yaml'
          service_branch: "${{ inputs.service_branch }}"
          service_name: 'pgskipper-services'
          restricted: false
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-services'
          namespace: 'pgskipper'

      - name: Verify Pgskipper Services installation
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Services_Installation_Migr_17'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 03 End ======= Services installation steps =======

      # == 04 Start ======= Migration steps =======
      - name: Major Upgrade Pgskipper Core to ${{ inputs.pg_18_image }}
        uses: ./qubership-test-pipelines/actions/shared/helm_deploy
        with:
          deploy_mode: 'upgrade'
          path_to_template: 'templates/pgskipper/patroni-core-majorupgrade.yaml'
          service_branch: "${{ inputs.service_branch }}"
          restricted: false
          service_name: 'pgskipper'
          repository_name: 'Netcracker/pgskipper-operator'
          path_to_chart: 'operator/charts/patroni-core'
          namespace: 'pgskipper'
          resource_folder: ''
          image_replacement: ${{ inputs.pg_18_image }}

      - name: Sleep after core upgrade
        run: sleep 30s

      - name: Verify Pgskipper Core upgrade
        uses: ./qubership-test-pipelines/actions/shared/verify_installation
        with:
          service_branch: "${{ inputs.service_branch }}"
          check_tests: true
          artifact_name: 'Core_Upgrade_Migr_to_18'
          namespace: 'pgskipper'
          service_ready_max_retries: 60
          service_ready_retry_interval: '10s'
          test_completion_max_retries: 60
          test_completion_retry_interval: '10s'
          crd_list: 'patronicores.netcracker.com'
      # == 04 End ======= Migration steps =======

      # == Start ======= Diagnostic steps =======
      - name: Collect diagnostic information
        if: always()
        run: |
          echo "::group::Describe nodes"
          kubectl describe nodes
          echo "::endgroup::"
          echo "::group::Get events"
          kubectl get events --sort-by=.metadata.creationTimestamp -n pgskipper
          echo "::endgroup::"
          echo "::group::Get pods"
          kubectl get pods -n pgskipper -o wide
          echo "::endgroup::"
      # == End ======= Diagnostic steps =======